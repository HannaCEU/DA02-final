---
title: "Higher risk of diabetes depending on income and living conditions"
author: "Hanna Asipovich"
date: "2022-12-19"
output: pdf_document
---

#####################
#Term Project -DA02 and Coding 1
#######################

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
rm(list=ls())
library(tidyverse)
library(httr)
library(dplyr)
library(AER)
library(lspline)
library(fixest)
library(modelsummary)
library(ggpubr)
library(reshape2)
library(kableExtra)
library(ggplot2)
library(haven)
library(data.table)
library(huxtable)
library(pscl)
library(patchwork)
library(MASS)
library(mfx)
library(tidyr)
library(estimatr)
install.packages("wbstats")
```

My GitHub repository's [**link**]("https://github.com/HannaCEU/DA02-final")

```{r message=FALSE, warning=FALSE, include=FALSE}
#Getting datasets from my Github repository
my_url <- "https://raw.githubusercontent.com/HannaCEU/DA02-final/main/raw_data/"
df <- read_csv(paste0(my_url, 'diabetes.csv'))
df1 <- read_csv(paste0(my_url, 'GNI.csv'))
df2 <- read_csv(paste0(my_url, 'water.csv'))
df3 <- read_csv(paste0(my_url, 'sanitation.csv'))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#data munging
# rename columns 
df <- df %>% rename(diabetes = '2021 [YR2021]')
df1 <- df1 %>% rename(gni = '2020 [YR2020]')
df2 <- df2 %>% rename(water = '2020 [YR2020]')
df3 <- df3 %>% rename(sanitation = '2020 [YR2020]')

#transformation of variables to numeric
df$diabetes <- as.numeric(df$diabetes)
df1$gni <- as.numeric(df1$gni) 
df2$water <- as.numeric(df2$water)
df3$sanitation <- as.numeric(df3$sanitation)

#drop NAs
df <- df %>% drop_na()
df1 <- df1 %>% drop_na()
df2 <- df2 %>% drop_na()
df3 <- df3 %>% drop_na()
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#joining the datasets
df4 <- left_join(df, df1, by = "Country Code")
df5 <- left_join(df2, df3, by = "Country Code")

df6 <- left_join(df4, df5, by = "Country Code")
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#further data cleaning 
# remove unnecessary columns
drops <- c("Series Name.x.x","Series Code.x.x","Series Name.y.x","Series Code.y.x","Country Name.y.x","Series Name.x.y","Series Code.x.y","Country Name.x.y", "Series Name.y.y","Series Code.y.y","Country Name.y.y")
df6 <- df6[ , !(names(df6) %in% drops)]
#checking nas, about 20-25% of data is missing for each variable
sum(is.na(df6$sanitation))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#cleaning environment
rm(df, df1, df2, df3, df5, df4, drops, my_url)
#writing out file
use_case_dir <- "C:/Users/grazh/Documents/CEU/Business analytics MSc/Fall semester/DA02/Final project/"
data_out <- use_case_dir
write_csv(df6,paste(data_out,"diabetes_inference.csv",sep=""))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#The above code is for the data manipulation showcase.  
#However, as an extra with wbstats package I can download data from the World Bank directly and in a tidy format, i.e. wide, without na, with values as numeric.
my_indicators = c("diabetes" = "SH.STA.DIAB.ZS",
                  "gni" = "NY.GNP.PCAP.CD",
                  "sanitation" = "SH.STA.BASS.ZS",
                  "water" = "SH.H2O.BASW.ZS")
df0 <- wbstats::wb_data(my_indicators, country = "countries_only", return_wide = TRUE, mrv = 1) 

df0 <- subset(df0, select = -c(date))
df0 <- df0[!is.na]
```

# Introduction

#Data and its key features

### Source

### Data Cleaning

### X, Y and Z Variables

#Summary statistics
On average 9% of global country population has diabetes(only in 5% of countries this figure goes below 2.4% of population). Average GNI(gross national income) is USD 14,244. 89% of population has access to drinking water(with 95% having their whole need covered), and 78% has access to basic sanitation(with 95% having their whole need covered). 

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Summary statistic
P95 <- function(x){quantile(x,0.95,na.rm=T)}
P05 <- function(x){quantile(x,0.05,na.rm=T)}
datasummary( (`% Population with diabetes` = diabetes ) + 
               (`GNI, Atlas method` = gni) +
               (`% Population with access to drinking water` = water) +
               (`% Population with access to basic sanitation` = sanitation)~
               Mean + Median + SD + Min + Max + P05 + P95 , 
             data = df6 ,
             title = 'Descriptive statistics') %>% 
  kable_styling(latex_options = c("HOLD_position","scale_down"))
```
# Correlation Matrix

To assess association between dependent, independent and z-variables I produced a correlation matrix (see Appendix). 
INCLUDE ANALYSIS

#Hypothesis 
Our hypothesis is that higher % of population with diabetes is associated with the income inequalities and life conditions (access to sanitation, drinking water).
WRITE UP 


## Models
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Carrying out data transformation
#log of gni 
df6 <- df6 %>%
  mutate(lngni=log(gni))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#having analysed the datasummary, I created a binary variable on higher diabetes levels for the countries where it is above 9% of population
df6$prone_diabetes <- ifelse(df6$diabetes>=9, 1, 0)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Simple regressions on diabetes
regr1 <- lm(diabetes ~ lngni, data = df6)
regr2 <- lm_robust(diabetes ~ lngni, data = df6, se_type = "HC1")

msummary(list(regr1, regr2),
         fmt="%.4f",
         gof_omit = 'DF|Deviance|Log.Lik.|F|R2 Adj.|AIC|BIC',
         stars=c('*' = .05, '**' = .01)
) %>% kableExtra::kable_styling(latex_options = "hold_position")
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
#creating model formula
model_formula <- formula(prone_diabetes ~ lngni + water + sanitation)

# Logit coefficients
logit <- glm(model_formula, data=df6, family = binomial (link = "logit"))


# Probit coefficients
probit <- glm(model_formula, data = df6, family=binomial(link="probit"))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Summary of all regression models
cm <- c('(Intercept)' = 'Constant')
summary1 <- msummary(list("(1) LPM0" = regr1, "(2)LPM" = regr2, "(3) logit coeffs" = logit, "(4) Probit" = probit),
                     fmt="%.3f",
                     gof_omit = 'DF|Deviance|Log.Lik.|F|R2 Adj.|AIC|BIC|R2|PseudoR2',
                     stars=c('*' = .05, '**' = .01),
                     coef_rename = cm,
                     title = "The Probability of diabetes occurence- LPM, Logit, and Probit models"
)

summary1

lpmdiabetes<- feols(prone_diabetes ~ lngni , data = df6 , vcov = 'hetero' )
```





# Appendix

## Correlation Matrix

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Check the correlations of different variables
#
numeric_df <- keep( df6 , is.numeric )
cT <- cor(numeric_df , use = "complete.obs")
# Check for highly correlated values:
sum( abs(cT) >= 0.8 & cT != 1 ) / 2
# Find the correlations which are higher than 0.8
id_cr <- which( abs(cT) >= 0.8 & cT != 1 )
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#find correlation between variables
#Correlation1: diabetes and gni
cor1 <- cor(df6$diabetes, df6$lngni, method = "pearson", use = "complete.obs")
#correlation2:diabetes and access to drinking water
cor2 <- cor(df6$diabetes, df6$water, method = "pearson", use = "complete.obs")
#correlation3: diabetes and access to basic sanitation
cor3 <- cor(df6$diabetes, df6$sanitation, method = "pearson", use = "complete.obs")

print(cor1)
print(cor2)
print(cor3)
```



## DOESNOT RUN ERROR ON STAT
```{r echo=FALSE, message=FALSE, warning=FALSE}
#graph
graph1 <- ggplot(data = df6, aes(x = lngni, fill = lngni)) + 
  geom_histogram(stat='count') + 
  labs(x='lngni', y='diabetes', fill='diabetes') + geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "blue")

graph1
```


#DOES NOT RUN ERROR ON FILL=VALUE
```{r message=FALSE, warning=FALSE, include=FALSE}
# Correlation matrix
cT <- round( cor( df6$diabetes, df6$gni, use = "complete.obs"), 2)
# create a lower triangular matrix
cT[ upper.tri( cT ) ] <- NA
# Put it into a tibble format
melted_cormat <- melt( cT , na.rm = TRUE)

corr_mat <- ggplot( data = df6, aes( df6$diabetes, df6$gni, use = "complete.obs", fill = value ) )+
  geom_tile( color = "white" ) +
  scale_fill_gradient2(low = "navyblue", high = "darkgreen", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Correlation") +
  theme_bw()+ 
  theme( axis.text.x = element_text(angle = 45, vjust = 1, 
                                    size = 10, hjust = 1))+
  labs(y="",x="")+
  coord_fixed() +
  ggtitle("Correlation Matrix")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
corr_mat
```

